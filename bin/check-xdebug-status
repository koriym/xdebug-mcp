#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Check Xdebug status and port availability before running comprehensive tests
 */

// Colors for output
define('GREEN', "\033[32m");
define('RED', "\033[31m");
define('YELLOW', "\033[33m");
define('BLUE', "\033[34m");
define('RESET', "\033[0m");

function checkPortListening(string $host, int $port): bool
{
    $connection = @fsockopen($host, $port, $errno, $errstr, 1);
    if ($connection) {
        fclose($connection);
        return true;
    }
    return false;
}

function checkXdebugExtension(): array
{
    $info = [
        'loaded' => extension_loaded('xdebug'),
        'version' => '',
        'modes' => '',
        'client_host' => '',
        'client_port' => '',
        'idekey' => ''
    ];

    if ($info['loaded']) {
        $info['version'] = phpversion('xdebug') ?: 'unknown';
        $info['modes'] = ini_get('xdebug.mode') ?: 'off';
        $info['client_host'] = ini_get('xdebug.client_host') ?: '127.0.0.1';
        $info['client_port'] = (int)(ini_get('xdebug.client_port') ?: 9003);
        $info['idekey'] = ini_get('xdebug.idekey') ?: '';
    }

    return $info;
}

echo BLUE . "üîç Xdebug Status Check\n" . RESET;
echo "=" . str_repeat("=", 50) . "\n\n";

// Check Xdebug extension
echo "üì¶ Checking Xdebug Extension...\n";
$xdebugInfo = checkXdebugExtension();

if ($xdebugInfo['loaded']) {
    echo GREEN . "‚úÖ Xdebug extension is loaded\n" . RESET;
    echo "   Version: {$xdebugInfo['version']}\n";
    echo "   Modes: {$xdebugInfo['modes']}\n";
    echo "   Client host: {$xdebugInfo['client_host']}\n";
    echo "   Client port: {$xdebugInfo['client_port']}\n";
    if (!empty($xdebugInfo['idekey'])) {
        echo "   IDE key: {$xdebugInfo['idekey']}\n";
    }
} else {
    echo RED . "‚ùå Xdebug extension is not loaded\n" . RESET;
    echo YELLOW . "üí° To load Xdebug, add to php.ini:\n" . RESET;
    echo "   zend_extension=xdebug\n";
    echo "   xdebug.mode=debug,profile,coverage\n";
}

echo "\nüîå Checking Port Availability...\n";

// Check MCP server port (9004)
$mcpPort = 9004;
$mcpHost = '127.0.0.1';

if (checkPortListening($mcpHost, $mcpPort)) {
    echo GREEN . "‚úÖ Port $mcpPort is available (someone is listening)\n" . RESET;
} else {
    echo YELLOW . "‚ö†Ô∏è  Port $mcpPort is not listening\n" . RESET;
}

// Check standard Xdebug port (9003)
$xdebugPort = 9003;
if (checkPortListening($mcpHost, $xdebugPort)) {
    echo GREEN . "‚úÖ Standard Xdebug port $xdebugPort is available\n" . RESET;
} else {
    echo YELLOW . "‚ö†Ô∏è  Standard Xdebug port $xdebugPort is not listening\n" . RESET;
}

echo "\nüß™ Testing MCP Server Basic Functionality...\n";

// Test MCP server tools/list
$listRequest = json_encode([
    'jsonrpc' => '2.0',
    'id' => 1,
    'method' => 'tools/list'
]);

$command = sprintf('echo %s | php bin/xdebug-mcp 2>/dev/null', escapeshellarg($listRequest));
$output = shell_exec($command);

if ($output && str_contains($output, '"tools"')) {
    echo GREEN . "‚úÖ MCP Server is responding\n" . RESET;
    
    // Count tools
    if (preg_match('/"tools":\[([^\]]+)\]/', $output, $matches)) {
        $toolCount = substr_count($matches[1], '"name"');
        echo "   Available tools: $toolCount\n";
    }
} else {
    echo RED . "‚ùå MCP Server is not responding properly\n" . RESET;
}

echo "\n" . "=" . str_repeat("=", 50) . "\n";
echo BLUE . "üìã Recommendations\n" . RESET;
echo "=" . str_repeat("=", 50) . "\n";

if (!$xdebugInfo['loaded']) {
    echo RED . "‚ùå Install and enable Xdebug extension first\n" . RESET;
} elseif (!str_contains($xdebugInfo['modes'], 'debug')) {
    echo YELLOW . "‚ö†Ô∏è  Enable debug mode: xdebug.mode=debug\n" . RESET;
} else {
    echo GREEN . "‚úÖ Xdebug is properly configured\n" . RESET;
}

echo "\n" . BLUE . "üöÄ Next Steps:\n" . RESET;

if ($xdebugInfo['loaded'] && str_contains($xdebugInfo['modes'], 'debug')) {
    echo GREEN . "‚úÖ Ready for comprehensive testing!\n" . RESET;
    echo "\nüìù Testing options:\n";
    echo "1. Test without debugging session:\n";
    echo "   ./bin/quick-test-tools\n\n";
    echo "2. Test with debugging session:\n";
    echo "   Terminal 1: php -dxdebug.mode=debug -dxdebug.start_with_request=yes test/debug_test.php\n";
    echo "   Terminal 2: ./bin/test-with-session\n\n";
    echo "3. Test all CLI tools:\n";
    echo "   ./bin/xdebug-trace /tmp/test_args.php\n";
    echo "   ./bin/xdebug-profile /tmp/test_args.php\n";
    echo "   ./bin/xdebug-coverage /tmp/test_args.php --text\n";
} else {
    echo YELLOW . "‚ö†Ô∏è  Configure Xdebug first, then run tests\n" . RESET;
    echo "\nüìù Basic testing (without debug session):\n";
    echo "   ./bin/quick-test-tools\n";
}

echo "\n" . BLUE . "üí° Port Information:\n" . RESET;
echo "   - MCP Server uses port 9004 (to avoid IDE conflicts)\n";
echo "   - Standard Xdebug uses port 9003\n";
echo "   - Check listening ports: netstat -an | grep LISTEN | grep 900\n";