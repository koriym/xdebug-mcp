#!/usr/bin/env php
<?php

declare(strict_types=1);

$projectRoot = require __DIR__ . '/autoload.php';

// Show help if requested
if (in_array('--help', $argv) || in_array('-h', $argv) || count($argv) < 4) {
    echo "Usage: xdebug-coverage -- php script.php [args...]\n";
    echo "\n";
    echo "Executes PHP scripts with Xdebug code coverage and provides coverage analysis.\n";
    echo "\n";
    echo "Examples:\n";
    echo "  xdebug-coverage -- php test.php\n";
    echo "  xdebug-coverage -- php -f script.php arg1 arg2\n";
    echo "\n";
    exit(0);
}

// Skip: [0]="xdebug-coverage" [1]="--" [2]="php"
$targetFile = $argv[3] ?? '';           // script.php
$phpArgs = array_slice($argv, 4); // remaining args

// Create coverage scripts
// NOTE: Cannot use register_shutdown_function() directly in current process
// because Xdebug functions require Xdebug to be enabled in the target process
$srcPath = $projectRoot . '/src';

$prependScript = tempnam(sys_get_temp_dir(), 'coverage_start_');
file_put_contents($prependScript, "<?php
xdebug_set_filter(XDEBUG_FILTER_CODE_COVERAGE, XDEBUG_PATH_INCLUDE, ['$srcPath/']);
xdebug_start_code_coverage(XDEBUG_CC_UNUSED | XDEBUG_CC_DEAD_CODE);

register_shutdown_function(function() {
    \$coverage = xdebug_get_code_coverage();
    \$result = [];
    
    foreach (\$coverage as \$file => \$lines) {
        \$covered = \$uncovered = [];
        
        foreach (\$lines as \$line => \$status) {
            if (\$status === 1) {
                \$covered[] = \$line;
            } elseif (\$status === -1) {
                \$uncovered[] = \$line;
            }
        }
        
        \$total = count(\$covered) + count(\$uncovered);
        \$result[\$file] = [
            'coverage' => \$total > 0 ? round(count(\$covered) / \$total * 100, 1) : 0,
            'lines_total' => \$total,
            'lines_covered' => count(\$covered),
            'covered_lines' => \$covered,
            'uncovered_lines' => \$uncovered
        ];
    }
    
    echo json_encode(\$result, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
});");

// Execute with Xdebug coverage
$xdebugOptions = [
    '-dzend_extension=xdebug',
    '-dxdebug.mode=coverage',
    "-dauto_prepend_file=$prependScript"
];

$cmd = 'php ' . implode(' ', array_map('escapeshellarg', array_merge($xdebugOptions, [$targetFile], $phpArgs)));
$exitCode = 0;
$output = shell_exec($cmd . ' 2>&1');
echo $output;

unlink($prependScript);

// Always suggest Claude analysis for coverage data  
echo "\nðŸ’¡ Analyze with Claude Code:\n";
echo "   claude \"Analyze the code coverage data above\"\n";

exit($exitCode);
